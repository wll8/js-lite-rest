<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UMD 测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>js-lite-rest UMD 测试</h1>
  <div id="results"></div>

  <!-- 加载 UMD 文件 -->
  <script src="../dist/js-lite-rest.umd.js"></script>

  <script>
    const resultsDiv = document.getElementById('results');

    function addResult(message, isSuccess = true) {
      const div = document.createElement('div');
      div.className = `test-result ${isSuccess ? 'success' : 'error'}`;
      div.textContent = message;
      resultsDiv.appendChild(div);

      // 也输出到控制台以便 Playwright 捕获
      console.log(`[TEST] ${isSuccess ? 'PASS' : 'FAIL'}: ${message}`);

      return isSuccess;
    }

    async function runTests() {
      let allPassed = true;

      try {
        // 测试 1: 检查 JsLiteRest 全局对象是否存在
        if (typeof JsLiteRest !== 'undefined') {
          addResult('✓ JsLiteRest 全局对象存在', true);
        } else {
          allPassed = addResult('✗ JsLiteRest 全局对象不存在', false);
          return;
        }

        // 测试 2: 检查 create 方法是否存在
        if (typeof JsLiteRest.create === 'function') {
          addResult('✓ JsLiteRest.create 方法存在', true);
        } else {
          allPassed = addResult('✗ JsLiteRest.create 方法不存在', false);
        }

        // 测试 3: 检查 lib 属性是否存在
        if (JsLiteRest.lib && JsLiteRest.lib.localforage) {
          addResult('✓ JsLiteRest.lib.localforage 存在', true);
        } else {
          allPassed = addResult('✗ JsLiteRest.lib.localforage 不存在', false);
        }

        // 测试 4: 创建 store 实例
        const store = await JsLiteRest.create({
          books: [
            { id: 1, title: 'JavaScript 高级程序设计' },
            { id: 2, title: 'Vue.js 设计与实现' }
          ]
        }, {
          savePath: 'umd-test-store'
        });

        if (store) {
          addResult('✓ 成功创建 store 实例', true);
        } else {
          allPassed = addResult('✗ 创建 store 实例失败', false);
          return;
        }

        // 测试 5: 测试 GET 操作
        const books = await store.get('books');
        if (Array.isArray(books) && books.length === 2) {
          addResult(`✓ GET 操作成功，获取到 ${books.length} 条数据`, true);
        } else {
          allPassed = addResult('✗ GET 操作失败', false);
        }

        // 测试 6: 测试 POST 操作
        const newBook = await store.post('books', { title: 'TypeScript 编程' });
        if (newBook && newBook.title === 'TypeScript 编程') {
          addResult('✓ POST 操作成功', true);
        } else {
          allPassed = addResult('✗ POST 操作失败', false);
        }

        // 测试 7: 验证数据已增加
        const updatedBooks = await store.get('books');
        if (updatedBooks.length === 3) {
          addResult(`✓ 数据持久化成功，当前有 ${updatedBooks.length} 条数据`, true);
        } else {
          allPassed = addResult('✗ 数据持久化失败', false);
        }

        // 测试 8: 测试 PUT 操作
        const updatedBook = await store.put('books/1', { id: 1, title: 'JavaScript 权威指南' });
        if (updatedBook && updatedBook.title === 'JavaScript 权威指南') {
          addResult('✓ PUT 操作成功', true);
        } else {
          allPassed = addResult('✗ PUT 操作失败', false);
        }

        // 测试 9: 测试 DELETE 操作
        const deleteResult = await store.delete('books/2');
        // lite 拦截器返回被删除的数据，而不是状态码
        if (deleteResult && deleteResult.id === 2) {
          addResult('✓ DELETE 操作成功', true);
        } else {
          allPassed = addResult('✗ DELETE 操作失败', false);
        }

        // 测试 10: 清理测试数据
        await JsLiteRest.lib.localforage.removeItem('umd-test-store');
        addResult('✓ 测试数据清理完成', true);

        // 最终结果
        if (allPassed) {
          addResult('========== 所有测试通过 ==========', true);
          console.log('[TEST] ALL_TESTS_PASSED');
          window.testsPassed = true;
        } else {
          addResult('========== 部分测试失败 ==========', false);
          window.testsPassed = false;
        }

      } catch (error) {
        addResult(`✗ 测试过程中发生错误: ${error.message}`, false);
        console.error('[TEST] ERROR:', error);
        window.testsPassed = false;
      }
    }

    // 页面加载完成后运行测试
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runTests);
    } else {
      runTests();
    }
  </script>
</body>
</html>
