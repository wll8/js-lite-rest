<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>浏览器 UMD 导入测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    #results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>浏览器 UMD 导入测试</h1>
  <p><small>通过 &lt;script&gt; 标签加载 UMD 格式</small></p>
  <div id="results"></div>

  <!-- 加载 UMD 文件 -->
  <script src="../../dist/js-lite-rest.umd.js"></script>

  <script>
    const resultsDiv = document.getElementById('results');

    function addResult(message, isSuccess = true) {
      const div = document.createElement('div');
      div.className = `result ${isSuccess ? 'success' : 'error'}`;
      div.textContent = message;
      resultsDiv.appendChild(div);
      console.log(`[TEST] ${isSuccess ? 'PASS' : 'FAIL'}: ${message}`);
      return isSuccess;
    }

    console.log('\n========== 浏览器 UMD 环境测试 ==========');

    async function runTests() {
      let allPassed = true;

      try {
        // 测试 1: 检查全局对象
        if (typeof JsLiteRest !== 'undefined') {
          addResult('✓ UMD 全局对象 JsLiteRest 存在', true);
        } else {
          allPassed = addResult('✗ UMD 全局对象 JsLiteRest 不存在', false);
          throw new Error('JsLiteRest 未定义');
        }

        // 测试 2: 检查 create 方法
        if (typeof JsLiteRest.create === 'function') {
          addResult('✓ JsLiteRest.create 方法存在', true);
        } else {
          allPassed = addResult('✗ JsLiteRest.create 方法不存在', false);
          throw new Error('create 方法不存在');
        }

        // 测试 3: 检查 lib 属性
        if (JsLiteRest.lib && JsLiteRest.lib.localforage) {
          addResult('✓ JsLiteRest.lib.localforage 存在', true);
        } else {
          allPassed = addResult('✗ JsLiteRest.lib.localforage 不存在', false);
        }

        // 测试 4: 创建 store 实例
        const store = await JsLiteRest.create({
          notes: [
            { id: 1, content: '第一条笔记', tags: ['work'] },
            { id: 2, content: '第二条笔记', tags: ['personal'] }
          ]
        }, {
          savePath: 'test-umd-store'
        });
        addResult('✓ 成功创建 store 实例', true);

        // 测试 5: GET 操作
        const notes = await store.get('notes');
        if (Array.isArray(notes) && notes.length === 2) {
          addResult(`✓ GET 操作成功，获取到 ${notes.length} 条数据`, true);
        } else {
          allPassed = addResult('✗ GET 操作失败', false);
        }

        // 测试 6: POST 批量操作
        const newNotes = await store.post('notes', [
          { content: '第三条笔记', tags: ['work', 'urgent'] },
          { content: '第四条笔记', tags: ['personal'] }
        ]);
        if (Array.isArray(newNotes) && newNotes.length === 2) {
          addResult('✓ POST 批量操作成功', true);
        } else {
          allPassed = addResult('✗ POST 批量操作失败', false);
        }

        // 测试 7: 验证批量操作后的数据
        const allNotes = await store.get('notes');
        if (Array.isArray(allNotes) && allNotes.length === 4) {
          addResult(`✓ 数据验证成功，共 ${allNotes.length} 条笔记`, true);
        } else {
          allPassed = addResult('✗ 数据验证失败', false);
        }

        // 测试 8: DELETE 操作
        const deleted = await store.delete('notes/1');
        if (deleted && deleted.id === 1) {
          addResult('✓ DELETE 操作成功', true);
        } else {
          allPassed = addResult('✗ DELETE 操作失败', false);
        }

        // 测试 9: 清理测试数据
        await JsLiteRest.lib.localforage.removeItem('test-umd-store');
        addResult('✓ 测试数据清理完成', true);

        if (allPassed) {
          addResult('========== UMD 测试全部通过 ==========', true);
          console.log('[TEST] ALL_TESTS_PASSED');
          window.testsPassed = true;
        } else {
          addResult('========== 部分测试失败 ==========', false);
          window.testsPassed = false;
        }

      } catch (error) {
        addResult(`✗ 测试过程中发生错误: ${error.message}`, false);
        console.error('[TEST] ERROR:', error);
        window.testsPassed = false;
      }
    }

    // 页面加载完成后运行测试
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runTests);
    } else {
      runTests();
    }
  </script>
</body>
</html>
