<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>浏览器 ESM 导入测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    #results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>浏览器 ES Module 导入测试</h1>
  <div id="results"></div>

  <script type="module">
    const resultsDiv = document.getElementById('results');

    function addResult(message, isSuccess = true) {
      const div = document.createElement('div');
      div.className = `result ${isSuccess ? 'success' : 'error'}`;
      div.textContent = message;
      resultsDiv.appendChild(div);
      console.log(`[TEST] ${isSuccess ? 'PASS' : 'FAIL'}: ${message}`);
      return isSuccess;
    }

    console.log('\n========== 浏览器 ES Module 环境测试 ==========');

    async function runTests() {
      let allPassed = true;

      try {
        // 测试 1: 动态导入浏览器 ESM
        const { default: JsLiteRest } = await import('../../dist/js-lite-rest.browser.mjs');
        addResult('✓ 浏览器 ES Module import 成功', true);

        // 测试 2: 检查导出结构
        if (JsLiteRest && JsLiteRest.create) {
          addResult('✓ JsLiteRest.create 方法存在', true);
        } else {
          allPassed = addResult('✗ JsLiteRest.create 方法不存在', false);
          throw new Error('JsLiteRest.create 方法不存在');
        }

        // 测试 3: 检查浏览器特有的 lib 属性
        if (JsLiteRest.lib && JsLiteRest.lib.localforage) {
          addResult('✓ JsLiteRest.lib.localforage 存在', true);
        } else {
          allPassed = addResult('✗ JsLiteRest.lib.localforage 不存在', false);
          throw new Error('JsLiteRest.lib.localforage 不存在');
        }

        // 测试 4: 创建 store 实例
        const store = await JsLiteRest.create({
          tasks: [
            { id: 1, title: '学习 JavaScript', done: true },
            { id: 2, title: '学习 TypeScript', done: false }
          ]
        }, {
          savePath: 'test-browser-esm-store'
        });
        addResult('✓ 成功创建 store 实例', true);

        // 测试 5: GET 操作
        const tasks = await store.get('tasks');
        if (Array.isArray(tasks) && tasks.length === 2) {
          addResult(`✓ GET 操作成功，获取到 ${tasks.length} 条数据`, true);
        } else {
          allPassed = addResult('✗ GET 操作失败', false);
          throw new Error('GET 操作失败');
        }

        // 测试 6: PATCH 操作
        const patched = await store.patch('tasks/2', { done: true });
        if (patched && patched.done === true && patched.title === '学习 TypeScript') {
          addResult('✓ PATCH 操作成功', true);
        } else {
          allPassed = addResult('✗ PATCH 操作失败', false);
          throw new Error('PATCH 操作失败');
        }

        // 测试 7: 验证 PATCH 后的数据
        const allTasks = await store.get('tasks');
        const completedCount = allTasks.filter(t => t.done === true).length;
        if (completedCount === 2) {
          addResult(`✓ 数据验证成功，找到 ${completedCount} 条已完成任务`, true);
        } else {
          allPassed = addResult('✗ 数据验证失败', false);
        }

        // 测试 8: 清理测试数据
        await JsLiteRest.lib.localforage.removeItem('test-browser-esm-store');
        addResult('✓ 测试数据清理完成', true);

        if (allPassed) {
          addResult('========== 浏览器 ESM 测试全部通过 ==========', true);
          console.log('[TEST] ALL_TESTS_PASSED');
          window.testsPassed = true;
        } else {
          addResult('========== 部分测试失败 ==========', false);
          window.testsPassed = false;
        }

      } catch (error) {
        addResult(`✗ 测试过程中发生错误: ${error.message}`, false);
        console.error('[TEST] ERROR:', error);
        window.testsPassed = false;
      }
    }

    runTests();
  </script>
</body>
</html>
