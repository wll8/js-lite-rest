<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­é—´ä»¶ç¤ºä¾‹ - js-lite-rest</title>
    <!-- UnoCSS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@unocss/runtime/uno.global.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.css">
    <!-- js-lite-rest UMD -->
    <script src="https://unpkg.com/js-lite-rest/dist/js-lite-rest.browser.umd.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <nav class="mb-4">
                <a href="./index.html" class="text-blue-600 hover:text-blue-800">â† è¿”å›ç¤ºä¾‹é¦–é¡µ</a>
            </nav>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ä¸­é—´ä»¶ç¤ºä¾‹</h1>
            <p class="text-gray-600">æ¼”ç¤º js-lite-rest çš„ä¸­é—´ä»¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ—¥å¿—è®°å½•ã€æ•°æ®éªŒè¯ã€æƒé™æ§åˆ¶ç­‰</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ä¸­é—´ä»¶æ§åˆ¶é¢æ¿ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ä¸­é—´ä»¶æ§åˆ¶</h2>
                
                <!-- ä¸­é—´ä»¶å¼€å…³ -->
                <div class="space-y-4 mb-6">
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div>
                            <h3 class="font-medium">æ—¥å¿—ä¸­é—´ä»¶</h3>
                            <p class="text-sm text-gray-600">è®°å½•æ‰€æœ‰ API è°ƒç”¨</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="logMiddleware" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div>
                            <h3 class="font-medium">éªŒè¯ä¸­é—´ä»¶</h3>
                            <p class="text-sm text-gray-600">éªŒè¯æ•°æ®æ ¼å¼å’Œå¿…å¡«å­—æ®µ</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="validationMiddleware" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div>
                            <h3 class="font-medium">æƒé™ä¸­é—´ä»¶</h3>
                            <p class="text-sm text-gray-600">æ¨¡æ‹Ÿç”¨æˆ·æƒé™æ£€æŸ¥</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="authMiddleware" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div>
                            <h3 class="font-medium">ç¼“å­˜ä¸­é—´ä»¶</h3>
                            <p class="text-sm text-gray-600">ç¼“å­˜ GET è¯·æ±‚ç»“æœ</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="cacheMiddleware" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>

                <button onclick="setupMiddlewares()" 
                        class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors mb-4">
                    é‡æ–°é…ç½®ä¸­é—´ä»¶
                </button>

                <!-- ç”¨æˆ·æƒé™è®¾ç½® -->
                <div class="p-3 border border-gray-200 rounded-lg">
                    <h3 class="font-medium mb-2">ç”¨æˆ·æƒé™è®¾ç½®</h3>
                    <select id="userRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="admin">ç®¡ç†å‘˜ (æ‰€æœ‰æƒé™)</option>
                        <option value="user">æ™®é€šç”¨æˆ· (åªè¯»æƒé™)</option>
                        <option value="guest">è®¿å®¢ (æ— æƒé™)</option>
                    </select>
                </div>
            </div>

            <!-- æ“ä½œæµ‹è¯•é¢æ¿ -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">æ“ä½œæµ‹è¯•</h2>
                
                <!-- äº§å“æ“ä½œ -->
                <div class="space-y-4">
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h3 class="font-semibold mb-3">æ·»åŠ äº§å“ (POST)</h3>
                        <div class="space-y-2">
                            <input type="text" id="productName" placeholder="äº§å“åç§°" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="number" id="productPrice" placeholder="ä»·æ ¼" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="productCategory" placeholder="åˆ†ç±»" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="addProduct()" 
                                    class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition-colors">
                                æ·»åŠ äº§å“
                            </button>
                        </div>
                    </div>

                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h3 class="font-semibold mb-3">è·å–äº§å“ (GET)</h3>
                        <div class="flex space-x-2">
                            <button onclick="getProducts()" 
                                    class="flex-1 bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">
                                è·å–æ‰€æœ‰äº§å“
                            </button>
                            <button onclick="getProducts(true)" 
                                    class="flex-1 bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition-colors">
                                æµ‹è¯•ç¼“å­˜
                            </button>
                        </div>
                    </div>

                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h3 class="font-semibold mb-3">æ›´æ–°äº§å“ (PUT)</h3>
                        <div class="space-y-2">
                            <input type="number" id="updateProductId" placeholder="äº§å“ID" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="updateProductName" placeholder="æ–°äº§å“åç§°" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="updateProduct()" 
                                    class="w-full bg-yellow-600 text-white py-2 rounded-md hover:bg-yellow-700 transition-colors">
                                æ›´æ–°äº§å“
                            </button>
                        </div>
                    </div>

                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h3 class="font-semibold mb-3">åˆ é™¤äº§å“ (DELETE)</h3>
                        <div class="space-y-2">
                            <input type="number" id="deleteProductId" placeholder="äº§å“ID" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="deleteProduct()" 
                                    class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700 transition-colors">
                                åˆ é™¤äº§å“
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- äº§å“åˆ—è¡¨ -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">äº§å“åˆ—è¡¨</h2>
                <span id="productCount" class="text-sm text-gray-500">å…± 0 ä¸ªäº§å“</span>
            </div>
            <div id="productList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- äº§å“åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- ä¸­é—´ä»¶æ—¥å¿— -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">ä¸­é—´ä»¶æ—¥å¿—</h2>
                <button onclick="clearMiddlewareLog()" class="text-sm text-red-600 hover:text-red-800">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div id="middlewareLog" class="bg-gray-50 p-4 rounded-md h-64 overflow-y-auto font-mono text-sm">
                <!-- ä¸­é—´ä»¶æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <script>
        let store;
        let cache = new Map();
        
        // åˆå§‹åŒ– store
        async function initStore() {
            try {
                store = await createStore({
                    products: [
                        { id: 1, name: 'iPhone 15', price: 5999, category: 'æ‰‹æœº' },
                        { id: 2, name: 'MacBook Pro', price: 12999, category: 'ç”µè„‘' },
                        { id: 3, name: 'AirPods Pro', price: 1999, category: 'è€³æœº' }
                    ]
                });
                
                setupMiddlewares();
                logMiddleware('Store åˆå§‹åŒ–æˆåŠŸ');
                loadProducts();
            } catch (error) {
                logMiddleware('Store åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸­é—´ä»¶æ—¥å¿—è®°å½•
        function logMiddleware(message, type = 'info') {
            const logElement = document.getElementById('middlewareLog');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 
                              type === 'warning' ? 'text-yellow-600' : 'text-blue-600';
            logElement.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ¸…ç©ºä¸­é—´ä»¶æ—¥å¿—
        function clearMiddlewareLog() {
            document.getElementById('middlewareLog').innerHTML = '';
        }

        // è®¾ç½®ä¸­é—´ä»¶
        function setupMiddlewares() {
            // æ¸…é™¤ç°æœ‰ä¸­é—´ä»¶
            store.middlewares = [];
            
            // æ—¥å¿—ä¸­é—´ä»¶
            if (document.getElementById('logMiddleware').checked) {
                store.use(async (args, next, opt) => {
                    const [method, path, data] = args;
                    const startTime = Date.now();
                    logMiddleware(`ğŸ”„ ${method.toUpperCase()} ${path} - å¼€å§‹æ‰§è¡Œ`);
                    
                    try {
                        const result = await next();
                        const duration = Date.now() - startTime;
                        logMiddleware(`âœ… ${method.toUpperCase()} ${path} - æ‰§è¡ŒæˆåŠŸ (${duration}ms)`, 'success');
                        return result;
                    } catch (error) {
                        const duration = Date.now() - startTime;
                        logMiddleware(`âŒ ${method.toUpperCase()} ${path} - æ‰§è¡Œå¤±è´¥: ${error.message} (${duration}ms)`, 'error');
                        throw error;
                    }
                });
            }

            // éªŒè¯ä¸­é—´ä»¶
            if (document.getElementById('validationMiddleware').checked) {
                store.use(async (args, next, opt) => {
                    const [method, path, data] = args;
                    
                    if (method === 'post' && path === 'products') {
                        if (!data.name || !data.price || !data.category) {
                            const error = new Error('äº§å“ä¿¡æ¯ä¸å®Œæ•´ï¼šåç§°ã€ä»·æ ¼å’Œåˆ†ç±»éƒ½æ˜¯å¿…å¡«é¡¹');
                            logMiddleware(`ğŸš« éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                            throw error;
                        }
                        
                        if (typeof data.price !== 'number' || data.price <= 0) {
                            const error = new Error('ä»·æ ¼å¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—');
                            logMiddleware(`ğŸš« éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                            throw error;
                        }
                        
                        logMiddleware(`âœ… æ•°æ®éªŒè¯é€šè¿‡`, 'success');
                    }
                    
                    return next();
                });
            }

            // æƒé™ä¸­é—´ä»¶
            if (document.getElementById('authMiddleware').checked) {
                store.use(async (args, next, opt) => {
                    const [method, path] = args;
                    const userRole = document.getElementById('userRole').value;
                    
                    // æ£€æŸ¥æƒé™
                    if (userRole === 'guest') {
                        const error = new Error('è®¿å®¢æ— æƒé™æ‰§è¡Œä»»ä½•æ“ä½œ');
                        logMiddleware(`ğŸ”’ æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                        throw error;
                    }
                    
                    if (userRole === 'user' && ['post', 'put', 'patch', 'delete'].includes(method)) {
                        const error = new Error('æ™®é€šç”¨æˆ·åªæœ‰åªè¯»æƒé™');
                        logMiddleware(`ğŸ”’ æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                        throw error;
                    }
                    
                    logMiddleware(`ğŸ”“ æƒé™æ£€æŸ¥é€šè¿‡ (${userRole})`, 'success');
                    return next();
                });
            }

            // ç¼“å­˜ä¸­é—´ä»¶
            if (document.getElementById('cacheMiddleware').checked) {
                store.use(async (args, next, opt) => {
                    const [method, path, data] = args;
                    
                    if (method === 'get') {
                        const cacheKey = `${method}:${path}:${JSON.stringify(data || {})}`;
                        
                        if (cache.has(cacheKey)) {
                            logMiddleware(`ğŸ’¾ ç¼“å­˜å‘½ä¸­: ${path}`, 'success');
                            return cache.get(cacheKey);
                        }
                        
                        const result = await next();
                        cache.set(cacheKey, result);
                        logMiddleware(`ğŸ’¾ ç»“æœå·²ç¼“å­˜: ${path}`, 'info');
                        return result;
                    }
                    
                    // é GET è¯·æ±‚æ¸…é™¤ç›¸å…³ç¼“å­˜
                    if (['post', 'put', 'patch', 'delete'].includes(method)) {
                        const keysToDelete = [];
                        for (const key of cache.keys()) {
                            if (key.includes(path.split('/')[0])) {
                                keysToDelete.push(key);
                            }
                        }
                        keysToDelete.forEach(key => cache.delete(key));
                        if (keysToDelete.length > 0) {
                            logMiddleware(`ğŸ—‘ï¸ æ¸…é™¤äº† ${keysToDelete.length} ä¸ªç›¸å…³ç¼“å­˜`, 'warning');
                        }
                    }
                    
                    return next();
                });
            }
            
            logMiddleware('ä¸­é—´ä»¶é…ç½®å®Œæˆ', 'info');
        }

        // åŠ è½½äº§å“åˆ—è¡¨
        async function loadProducts() {
            try {
                const products = await store.get('products');
                displayProducts(products);
            } catch (error) {
                logMiddleware('åŠ è½½äº§å“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºäº§å“åˆ—è¡¨
        function displayProducts(products) {
            const productList = document.getElementById('productList');
            const productCount = document.getElementById('productCount');

            productCount.textContent = `å…± ${products.length} ä¸ªäº§å“`;

            if (products.length === 0) {
                productList.innerHTML = '<div class="col-span-full text-gray-500 text-center py-8">æš‚æ— äº§å“</div>';
                return;
            }

            productList.innerHTML = products.map(product => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-gray-800 mb-2">${product.name}</h3>
                    <p class="text-gray-600 text-sm mb-1">ID: ${product.id}</p>
                    <p class="text-gray-600 text-sm mb-1">åˆ†ç±»: ${product.category}</p>
                    <p class="text-lg font-bold text-green-600">Â¥${product.price}</p>
                </div>
            `).join('');
        }

        // æ·»åŠ äº§å“
        async function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value.trim();

            try {
                const newProduct = await store.post('products', { name, price, category });
                logMiddleware(`äº§å“æ·»åŠ æˆåŠŸ: ${newProduct.name}`, 'success');

                // æ¸…ç©ºè¡¨å•
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productCategory').value = '';

                loadProducts();
            } catch (error) {
                // é”™è¯¯å·²åœ¨ä¸­é—´ä»¶ä¸­è®°å½•
            }
        }

        // è·å–äº§å“
        async function getProducts(testCache = false) {
            try {
                if (testCache) {
                    logMiddleware('ğŸ§ª æµ‹è¯•ç¼“å­˜åŠŸèƒ½ - è¿ç»­ä¸¤æ¬¡è¯·æ±‚', 'info');
                    await store.get('products');
                    await store.get('products');
                } else {
                    const products = await store.get('products');
                    displayProducts(products);
                }
            } catch (error) {
                // é”™è¯¯å·²åœ¨ä¸­é—´ä»¶ä¸­è®°å½•
            }
        }

        // æ›´æ–°äº§å“
        async function updateProduct() {
            const id = parseInt(document.getElementById('updateProductId').value);
            const name = document.getElementById('updateProductName').value.trim();

            if (!id || !name) {
                logMiddleware('è¯·å¡«å†™äº§å“IDå’Œæ–°åç§°', 'error');
                return;
            }

            try {
                const updatedProduct = await store.patch(`products/${id}`, { name });
                if (updatedProduct) {
                    logMiddleware(`äº§å“æ›´æ–°æˆåŠŸ: ${updatedProduct.name}`, 'success');

                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('updateProductId').value = '';
                    document.getElementById('updateProductName').value = '';

                    loadProducts();
                } else {
                    logMiddleware(`äº§å“ ID ${id} ä¸å­˜åœ¨`, 'error');
                }
            } catch (error) {
                // é”™è¯¯å·²åœ¨ä¸­é—´ä»¶ä¸­è®°å½•
            }
        }

        // åˆ é™¤äº§å“
        async function deleteProduct() {
            const id = parseInt(document.getElementById('deleteProductId').value);

            if (!id) {
                logMiddleware('è¯·è¾“å…¥äº§å“ID', 'error');
                return;
            }

            try {
                const result = await store.delete(`products/${id}`);
                if (result) {
                    logMiddleware(`äº§å“åˆ é™¤æˆåŠŸ (ID: ${id})`, 'success');

                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('deleteProductId').value = '';

                    loadProducts();
                } else {
                    logMiddleware(`äº§å“ ID ${id} ä¸å­˜åœ¨`, 'error');
                }
            } catch (error) {
                // é”™è¯¯å·²åœ¨ä¸­é—´ä»¶ä¸­è®°å½•
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', initStore);
    </script>
</body>
</html>
