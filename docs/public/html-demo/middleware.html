<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸­é—´ä»¶ç¤ºä¾‹ - js-lite-rest</title>
  <!-- Vue 3 UMD -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- UnoCSS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@unocss/runtime/uno.global.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.css">
  <!-- js-lite-rest UMD -->
  <script src="https://unpkg.com/js-lite-rest/dist/js-lite-rest.umd.js"></script>
  <style>
    /* åˆå§‹ç™½å±æ ·å¼ï¼Œé˜²æ­¢æœªæ ·å¼åŒ–çš„å†…å®¹é—ªçƒ */
    body {
      background: #f9fafb;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* åœ¨UnoCSSåŠ è½½å‰å®Œå…¨éšè—æ‰€æœ‰å†…å®¹ï¼Œåªæ˜¾ç¤ºç™½å± */
    #app {
      display: none;
      min-height: 100vh;
    }

    /* UnoCSSåŠ è½½å®Œæˆåæ˜¾ç¤ºå†…å®¹ */
    #app.uno-ready {
      display: block;
      opacity: 0;
      animation: fadeIn 0.3s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* åŠ è½½çŠ¶æ€æ ·å¼ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <div id="app">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="isLoading" class="loading-overlay">
      <div class="text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-gray-600">{{ loadingMessage }}</p>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      <header class="mb-8">
        <nav class="mb-4">
          <a href="./index.html" class="text-blue-600 hover:text-blue-800">â† è¿”å›ç¤ºä¾‹é¦–é¡µ</a>
        </nav>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ä¸­é—´ä»¶ç¤ºä¾‹</h1>
        <p class="text-gray-600">æ¼”ç¤º js-lite-rest çš„ä¸­é—´ä»¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ—¥å¿—è®°å½•ã€æ•°æ®éªŒè¯ã€æƒé™æ§åˆ¶ç­‰</p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- ä¸­é—´ä»¶æ§åˆ¶é¢æ¿ -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4">ä¸­é—´ä»¶æ§åˆ¶</h2>
          
          <!-- ä¸­é—´ä»¶å¼€å…³ -->
          <div class="space-y-4 mb-6">
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
              <div>
                <h3 class="font-medium">æ—¥å¿—ä¸­é—´ä»¶</h3>
                <p class="text-sm text-gray-600">è®°å½•æ‰€æœ‰ API è°ƒç”¨</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" v-model="middlewareConfig.log" @change="applyMiddlewares" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
              <div>
                <h3 class="font-medium">éªŒè¯ä¸­é—´ä»¶</h3>
                <p class="text-sm text-gray-600">éªŒè¯æ•°æ®æ ¼å¼å’Œå¿…å¡«å­—æ®µ</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" v-model="middlewareConfig.validation" @change="applyMiddlewares" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
              <div>
                <h3 class="font-medium">æƒé™ä¸­é—´ä»¶</h3>
                <p class="text-sm text-gray-600">æ¨¡æ‹Ÿç”¨æˆ·æƒé™æ£€æŸ¥</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" v-model="middlewareConfig.auth" @change="applyMiddlewares" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
              <div>
                <h3 class="font-medium">ç¼“å­˜ä¸­é—´ä»¶</h3>
                <p class="text-sm text-gray-600">ç¼“å­˜ GET è¯·æ±‚ç»“æœ</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" v-model="middlewareConfig.cache" @change="applyMiddlewares" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
          </div>

          <!-- ç”¨æˆ·æƒé™è®¾ç½® -->
          <div class="p-3 border border-gray-200 rounded-lg mb-4">
            <h3 class="font-medium mb-2">ç”¨æˆ·æƒé™è®¾ç½®</h3>
            <select v-model="userRole" @change="applyMiddlewares" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="admin">ç®¡ç†å‘˜ (æ‰€æœ‰æƒé™)</option>
              <option value="user">æ™®é€šç”¨æˆ· (åªè¯»æƒé™)</option>
              <option value="guest">è®¿å®¢ (æ— æƒé™)</option>
            </select>
          </div>

          <button @click="resetToDefault" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition-colors">
            é‡ç½®ä¸­é—´ä»¶
          </button>
        </div>

        <!-- æ“ä½œæµ‹è¯•é¢æ¿ -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4">æ“ä½œæµ‹è¯•</h2>
          
          <!-- äº§å“æ“ä½œ -->
          <div class="space-y-4">
            <div class="p-4 border border-gray-200 rounded-lg">
              <h3 class="font-semibold mb-3">æ·»åŠ äº§å“ (POST)</h3>
              <div class="space-y-2">
                <input type="text" v-model="form.name" placeholder="äº§å“åç§°" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" v-model.number="form.price" placeholder="ä»·æ ¼" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" v-model="form.category" placeholder="åˆ†ç±»" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="addProduct" :disabled="!isFormValid"
                        :class="['w-full py-2 rounded-md transition-colors', isFormValid ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-400 text-gray-600 cursor-not-allowed']">
                  æ·»åŠ äº§å“
                </button>
              </div>
            </div>

            <div class="p-4 border border-gray-200 rounded-lg">
              <h3 class="font-semibold mb-3">è·å–äº§å“ (GET)</h3>
              <button @click="getProducts" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">
                è·å–æ‰€æœ‰äº§å“
              </button>
            </div>

            <div class="p-4 border border-gray-200 rounded-lg">
              <h3 class="font-semibold mb-3">æ›´æ–°äº§å“ (PUT)</h3>
              <div class="space-y-2">
                <input type="text" v-model="update.id" placeholder="äº§å“ID" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" v-model="update.name" placeholder="æ–°äº§å“åç§°" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="updateProduct" :disabled="!update.id || !update.name"
                        :class="['w-full py-2 rounded-md transition-colors', (update.id && update.name) ? 'bg-yellow-600 text-white hover:bg-yellow-700' : 'bg-gray-400 text-gray-600 cursor-not-allowed']">
                  æ›´æ–°äº§å“
                </button>
              </div>
            </div>

            <div class="p-4 border border-gray-200 rounded-lg">
              <h3 class="font-semibold mb-3">åˆ é™¤äº§å“ (DELETE)</h3>
              <div class="space-y-2">
                <input type="text" v-model="deleteId" placeholder="äº§å“ID" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="deleteProduct" :disabled="!deleteId"
                        :class="['w-full py-2 rounded-md transition-colors', deleteId ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-400 text-gray-600 cursor-not-allowed']">
                  åˆ é™¤äº§å“
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- äº§å“åˆ—è¡¨ -->
      <div class="mt-8 bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">äº§å“åˆ—è¡¨</h2>
          <span class="text-sm text-gray-500">å…± {{ products.length }} ä¸ªäº§å“</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div v-if="products.length === 0" class="col-span-full text-gray-500 text-center py-8">
            æš‚æ— äº§å“
          </div>
          <div v-for="product in products" :key="product.id" class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <h3 class="font-semibold text-gray-800 mb-2">{{ product.name }}</h3>
            <p class="text-gray-600 text-sm mb-1">ID: {{ product.id }}</p>
            <p class="text-gray-600 text-sm mb-1">åˆ†ç±»: {{ product.category }}</p>
            <p class="text-lg font-bold text-green-600">Â¥{{ product.price }}</p>
          </div>
        </div>
      </div>

      <!-- ä¸­é—´ä»¶æ—¥å¿— -->
      <div class="mt-8 bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">ä¸­é—´ä»¶æ—¥å¿—</h2>
          <button @click="clearMiddlewareLog" class="text-sm text-red-600 hover:text-red-800">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        <div class="bg-gray-50 p-4 rounded-md h-64 overflow-y-auto font-mono text-sm">
          <div v-for="(log, index) in middlewareLogs" :key="index" :class="log.class">
            [{{ log.timestamp }}] {{ log.message }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, reactive, onMounted, computed } = Vue;

    createApp({
      setup() {
        // å“åº”å¼æ•°æ®
        const store = ref(null);
        const products = ref([]);
        const middlewareLogs = ref([]);
        const cache = ref(new Map());
        const isLoading = ref(true);
        const loadingMessage = ref('æ­£åœ¨åŠ è½½èµ„æº...');
        const isUnoReady = ref(false);

        // ä¸­é—´ä»¶é…ç½®
        const middlewareConfig = reactive({
          log: true,
          validation: true,
          auth: false,
          cache: false
        });

        const userRole = ref('admin');

        // è¡¨å•æ•°æ®
        const form = reactive({
          name: '',
          price: null,
          category: ''
        });

        const update = reactive({
          id: '',
          name: ''
        });

        const deleteId = ref('');

        // è®¡ç®—å±æ€§ - è¡¨å•éªŒè¯
        const isFormValid = computed(() => {
          return form.name && form.price && form.price > 0 && form.category;
        });

        // æ£€æŸ¥ UnoCSS æ˜¯å¦å‡†å¤‡å¥½
        const checkUnoReady = () => {
          return new Promise((resolve) => {
            let checkCount = 0;
            const maxChecks = 50;

            const checkInterval = setInterval(() => {
              checkCount++;

              const hasRuntime = window.__unocss_runtime;
              const hasStyles = document.querySelector('style[data-unocss]') ||
                document.querySelector('link[href*="unocss"]') ||
                document.querySelector('style').textContent.includes('bg-gray-50');

              if ((hasRuntime || hasStyles) || checkCount >= maxChecks) {
                clearInterval(checkInterval);
                document.getElementById('app').className = 'uno-ready';
                resolve();
              }
            }, 100);
          });
        };

        // åˆå§‹åŒ– store
        const initStore = async () => {
          try {
            // ç­‰å¾… UnoCSS å‡†å¤‡å°±ç»ª
            loadingMessage.value = 'æ­£åœ¨åŠ è½½æ ·å¼èµ„æº...';
            await checkUnoReady();
            isUnoReady.value = true;

            loadingMessage.value = 'æ­£åœ¨åˆå§‹åŒ–æ•°æ®å­˜å‚¨...';

            store.value = await JsLiteRest.create({
              products: [
                { id: 1, name: 'iPhone 15', price: 5999, category: 'æ‰‹æœº' },
                { id: 2, name: 'MacBook Pro', price: 12999, category: 'ç”µè„‘' },
                { id: 3, name: 'AirPods Pro', price: 1999, category: 'è€³æœº' }
              ]
            });

            applyMiddlewares();
            logMiddleware('Store åˆå§‹åŒ–æˆåŠŸ');

            loadingMessage.value = 'æ­£åœ¨åŠ è½½äº§å“æ•°æ®...';
            await loadProducts();

            // åˆå§‹åŒ–å®Œæˆ
            setTimeout(() => {
              isLoading.value = false;
            }, 500);

          } catch (error) {
            logMiddleware('Store åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            loadingMessage.value = 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
            setTimeout(() => {
              isLoading.value = false;
            }, 2000);
          }
        };

        // ä¸­é—´ä»¶æ—¥å¿—è®°å½•
        const logMiddleware = (message, type = 'info') => {
          const timestamp = new Date().toLocaleTimeString();
          const colorClass = type === 'error' ? 'text-red-600' : 
                            type === 'success' ? 'text-green-600' : 
                            type === 'warning' ? 'text-yellow-600' : 'text-blue-600';
          middlewareLogs.value.push({
            timestamp,
            message,
            class: colorClass
          });
          // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          setTimeout(() => {
            const logContainer = document.querySelector('.bg-gray-50.overflow-y-auto');
            if (logContainer) {
              logContainer.scrollTop = logContainer.scrollHeight;
            }
          }, 0);
        };

        // æ¸…ç©ºä¸­é—´ä»¶æ—¥å¿—
        const clearMiddlewareLog = () => {
          middlewareLogs.value = [];
        };

        // åº”ç”¨ä¸­é—´ä»¶é…ç½®
        const applyMiddlewares = () => {
          if (!store.value) return;

          // å½“ç”¨æˆ·æƒé™ä¸æ˜¯ç®¡ç†å‘˜æ—¶ï¼Œè‡ªåŠ¨å¼€å¯æƒé™ä¸­é—´ä»¶
          if (userRole.value !== 'admin') {
            middlewareConfig.auth = true;
          }

          // æ¸…é™¤ç°æœ‰ä¸­é—´ä»¶
          store.value.middlewares = [];

          // æ—¥å¿—ä¸­é—´ä»¶
          if (middlewareConfig.log) {
            store.value.use(async (args, next, opt) => {
              const [method, path, data] = args;
              const startTime = Date.now();
              logMiddleware(`ğŸ”„ ${method.toUpperCase()} ${path} - å¼€å§‹æ‰§è¡Œ`);
              
              try {
                const result = await next();
                const duration = Date.now() - startTime;
                logMiddleware(`âœ… ${method.toUpperCase()} ${path} - æ‰§è¡ŒæˆåŠŸ (${duration}ms)`, 'success');
                return result;
              } catch (error) {
                const duration = Date.now() - startTime;
                logMiddleware(`âŒ ${method.toUpperCase()} ${path} - æ‰§è¡Œå¤±è´¥: ${error.message} (${duration}ms)`, 'error');
                throw error;
              }
            });
          }

          // éªŒè¯ä¸­é—´ä»¶
          if (middlewareConfig.validation) {
            store.value.use(async (args, next, opt) => {
              const [method, path, data] = args;
              
              if (method === 'post' && path === 'products') {
                if (!data.name || !data.price || !data.category) {
                  const error = new Error('äº§å“ä¿¡æ¯ä¸å®Œæ•´ï¼šåç§°ã€ä»·æ ¼å’Œåˆ†ç±»éƒ½æ˜¯å¿…å¡«é¡¹');
                  logMiddleware(`ğŸš« éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                  throw error;
                }
                
                if (typeof data.price !== 'number' || data.price <= 0) {
                  const error = new Error('ä»·æ ¼å¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—');
                  logMiddleware(`ğŸš« éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                  throw error;
                }
                
                logMiddleware(`âœ… æ•°æ®éªŒè¯é€šè¿‡`, 'success');
              }
              
              return next();
            });
          }

          // æƒé™ä¸­é—´ä»¶
          if (middlewareConfig.auth) {
            store.value.use(async (args, next, opt) => {
              const [method, path] = args;
              
              // æ£€æŸ¥æƒé™
              if (userRole.value === 'guest') {
                const error = new Error('è®¿å®¢æ— æƒé™æ‰§è¡Œä»»ä½•æ“ä½œ');
                logMiddleware(`ğŸ”’ æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                throw error;
              }
              
              if (userRole.value === 'user' && ['post', 'put', 'patch', 'delete'].includes(method)) {
                const error = new Error('æ™®é€šç”¨æˆ·åªæœ‰åªè¯»æƒé™');
                logMiddleware(`ğŸ”’ æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                throw error;
              }
              
              logMiddleware(`ğŸ”“ æƒé™æ£€æŸ¥é€šè¿‡ (${userRole.value})`, 'success');
              return next();
            });
          }

          // ç¼“å­˜ä¸­é—´ä»¶
          if (middlewareConfig.cache) {
            store.value.use(async (args, next, opt) => {
              const [method, path, data] = args;
              
              if (method === 'get') {
                const cacheKey = `${method}:${path}:${JSON.stringify(data || {})}`;
                
                if (cache.value.has(cacheKey)) {
                  logMiddleware(`ğŸ’¾ ç¼“å­˜å‘½ä¸­: ${path}`, 'success');
                  return cache.value.get(cacheKey);
                }
                
                const result = await next();
                cache.value.set(cacheKey, result);
                logMiddleware(`ğŸ’¾ ç»“æœå·²ç¼“å­˜: ${path}`, 'info');
                return result;
              }
              
              // é GET è¯·æ±‚æ¸…é™¤ç›¸å…³ç¼“å­˜
              if (['post', 'put', 'patch', 'delete'].includes(method)) {
                const keysToDelete = [];
                for (const key of cache.value.keys()) {
                  if (key.includes(path.split('/')[0])) {
                    keysToDelete.push(key);
                  }
                }
                keysToDelete.forEach(key => cache.value.delete(key));
                if (keysToDelete.length > 0) {
                  logMiddleware(`ğŸ—‘ï¸ æ¸…é™¤äº† ${keysToDelete.length} ä¸ªç›¸å…³ç¼“å­˜`, 'warning');
                }
              }
              
              return next();
            });
          }
          
          logMiddleware('ä¸­é—´ä»¶é…ç½®å·²åº”ç”¨', 'info');
        };

        // é‡ç½®åˆ°é»˜è®¤çŠ¶æ€
        const resetToDefault = () => {
          middlewareConfig.log = true;
          middlewareConfig.validation = true;
          middlewareConfig.auth = false;
          middlewareConfig.cache = false;
          userRole.value = 'admin';
          
          applyMiddlewares();
          logMiddleware('å·²é‡ç½®åˆ°é»˜è®¤çŠ¶æ€', 'warning');
        };

        // åŠ è½½äº§å“åˆ—è¡¨
        const loadProducts = async () => {
          try {
            const result = await store.value.get('products');
            let productList = result;
            if (result && typeof result === 'object' && result.data) {
              productList = result.data;
            } else if (!Array.isArray(result)) {
              productList = [];
            }
            products.value = productList;
          } catch (error) {
            logMiddleware('åŠ è½½äº§å“å¤±è´¥: ' + error.message, 'error');
            products.value = [];
          }
        };

        // æ˜¾ç¤ºäº§å“åˆ—è¡¨
        const getProducts = async () => {
          await loadProducts();
        };

        // æ·»åŠ äº§å“
        const addProduct = async () => {
          if (!isFormValid.value) {
            logMiddleware('è¯·å¡«å†™å®Œæ•´çš„äº§å“ä¿¡æ¯', 'error');
            return;
          }

          try {
            const result = await store.value.post('products', {
              name: form.name,
              price: form.price,
              category: form.category
            });
            
            const productName = result?.name || result?.data?.name || form.name;
            logMiddleware(`äº§å“æ·»åŠ æˆåŠŸ: ${productName}`, 'success');

            // æ¸…ç©ºè¡¨å•
            form.name = '';
            form.price = null;
            form.category = '';

            await loadProducts();
          } catch (error) {
            // é”™è¯¯å·²åœ¨ä¸­é—´ä»¶ä¸­è®°å½•
          }
        };

        // æ›´æ–°äº§å“
        const updateProduct = async () => {
          if (!update.id || !update.name) {
            logMiddleware('è¯·å¡«å†™äº§å“IDå’Œæ–°åç§°', 'error');
            return;
          }

          try {
            const result = await store.value.patch(`products/${update.id}`, { name: update.name });
            if (result) {
              const productName = result?.name || result?.data?.name || update.name;
              logMiddleware(`äº§å“æ›´æ–°æˆåŠŸ: ${productName}`, 'success');

              // æ¸…ç©ºè¡¨å•
              update.id = '';
              update.name = '';

              await loadProducts();
            } else {
              logMiddleware(`äº§å“ ID ${update.id} ä¸å­˜åœ¨`, 'error');
            }
          } catch (error) {
            // é”™è¯¯å·²åœ¨ä¸­é—´ä»¶ä¸­è®°å½•
          }
        };

        // åˆ é™¤äº§å“
        const deleteProduct = async () => {
          if (!deleteId.value) {
            logMiddleware('è¯·è¾“å…¥äº§å“ID', 'error');
            return;
          }

          try {
            const result = await store.value.delete(`products/${deleteId.value}`);
            if (result) {
              logMiddleware(`äº§å“åˆ é™¤æˆåŠŸ (ID: ${deleteId.value})`, 'success');

              // æ¸…ç©ºè¡¨å•
              deleteId.value = '';

              await loadProducts();
            } else {
              logMiddleware(`äº§å“ ID ${deleteId.value} ä¸å­˜åœ¨`, 'error');
            }
          } catch (error) {
            // é”™è¯¯å·²åœ¨ä¸­é—´ä»¶ä¸­è®°å½•
          }
        };

        // ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–
        onMounted(() => {
          initStore();
        });

        return {
          // çŠ¶æ€
          products,
          middlewareLogs,
          isLoading,
          loadingMessage,
          middlewareConfig,
          userRole,
          form,
          update,
          deleteId,
          // è®¡ç®—å±æ€§
          isFormValid,
          // æ–¹æ³•
          applyMiddlewares,
          resetToDefault,
          getProducts,
          addProduct,
          updateProduct,
          deleteProduct,
          clearMiddlewareLog
        };
      }
    }).mount('#app');
  </script>
</body>

</html>
